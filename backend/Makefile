# Backend Makefile

.PHONY: help help-full \
run-dev-backend clean-backend test-backend \
lint-backend lint-branch-backend \
format-backend format-branch-backend \
poetry-lock-backend build-backend \
logs-dev-backend attach-dev-backend status-dev-backend# Docker compose command with project name
DOCKER_COMPOSE := docker compose -p boneca

help:
	@printf "\n    ğŸ©° Boneca - Backend Service\n"
	@printf "    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
	@printf "    âš¡ Quick Actions\n"
	@printf "    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
	@printf "    âœ make run-dev       â”‚ Build and run development environment with hot reload\n"
	@printf "    âœ make logs          â”‚ Follow development server logs\n"
	@printf "    âœ make attach        â”‚ Attach to development server container\n"
	@printf "    âœ make status        â”‚ Check development server status\n"
	@printf "    âœ make test          â”‚ Run full test suite\n"
	@printf "    âœ make clean         â”‚ Stop and clean everything in boneca project\n"
	@printf "    âœ make lint-branch   â”‚ Run linting on files changed in current branch\n"
	@printf "    âœ make format-branch â”‚ Format files changed in current branch\n\n"
	@printf "    ğŸ“ Use 'make help-full' for complete documentation\n\n"

help-full:
	@printf "\n    ğŸ©° Boneca - Backend Service\n"
	@printf "    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
	@printf "    ğŸš€ Development Commands\n"
	@printf "    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
	@printf "    âœ make run-dev-backend       â”‚ Build and run development environment\n"
	@printf "    âœ make logs-dev-backend      â”‚ Follow development server logs\n"
	@printf "    âœ make attach-dev-backend    â”‚ Attach to development server container\n"
	@printf "    âœ make status-dev-backend    â”‚ Check development server status\n"
	@printf "    âœ make build-backend         â”‚ Build all Docker images\n"
	@printf "    âœ make poetry-lock-backend   â”‚ Update poetry.lock file in Docker\n\n"
	@printf "    ğŸ” Code Quality\n"
	@printf "    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
	@printf "    âœ make test-backend          â”‚ Run test suite in Docker\n"
	@printf "    âœ make lint-backend          â”‚ Run all linting in Docker\n"
	@printf "    âœ make lint-branch-backend   â”‚ Lint changed files in Docker\n"
	@printf "    âœ make format-backend        â”‚ Format all code in Docker\n"
	@printf "    âœ make format-branch-backend â”‚ Format changed files in Docker\n\n"
	@printf "    ğŸ§¹ Maintenance\n"
	@printf "    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
	@printf "    âœ make clean-backend         â”‚ Clean Docker resources and caches\n\n"
	@printf "    ğŸ“š Quick Examples\n"
	@printf "    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
	@printf "    Development workflow:\n"
	@printf "    1. $$ make run-dev-backend     # Start development server\n"
	@printf "    2. $$ make format-branch       # Format your changes\n"
	@printf "    3. $$ make lint-branch         # Check your changes\n"
	@printf "    4. $$ make test-backend        # Run tests\n\n"
	@printf "    Docker workflow:\n"
	@printf "    $$ make build-backend && make run-dev-backend\n\n"
	@printf "    API Endpoints:\n"
	@printf "    â€¢ http://localhost:8000/         - Welcome message\n"
	@printf "    â€¢ http://localhost:8000/api/v1/ping   - Health check\n"
	@printf "    â€¢ http://localhost:8000/api/v1/docs   - API documentation\n\n"

# Quick action aliases
run-dev: run-dev-backend
test: test-backend
clean: clean-backend
lint-branch: lint-branch-backend
format-branch: format-branch-backend
logs: logs-dev-backend
attach: attach-dev-backend
status: status-dev-backend

# Development commands
run-dev-backend:
	$(DOCKER_COMPOSE) build boneca-dev
	$(DOCKER_COMPOSE) --profile dev up -d boneca-dev

logs-dev-backend:
	$(DOCKER_COMPOSE) logs -f boneca-dev

attach-dev-backend:
	$(DOCKER_COMPOSE) attach boneca-dev

status-dev-backend:
	$(DOCKER_COMPOSE) ps boneca-dev

build-backend:
	$(DOCKER_COMPOSE) build

poetry-lock-backend:
	$(DOCKER_COMPOSE) run --rm boneca poetry lock

# Testing and quality commands
test-backend:
	$(DOCKER_COMPOSE) run --rm boneca poetry run pytest tests -v --cov=src

lint-backend:
	$(DOCKER_COMPOSE) run --rm boneca poetry run flake8 src tests
	$(DOCKER_COMPOSE) run --rm boneca poetry run mypy src tests
	$(DOCKER_COMPOSE) run --rm boneca poetry run black --check src tests
	$(DOCKER_COMPOSE) run --rm boneca poetry run isort --check-only src tests

lint-branch-backend:
	$(DOCKER_COMPOSE) run --rm boneca /bin/bash -c '\
		git diff --name-only origin/main | grep "\.py$$" | \
		xargs -r poetry run flake8 && \
		git diff --name-only origin/main | grep "\.py$$" | \
		xargs -r poetry run black --check && \
		git diff --name-only origin/main | grep "\.py$$" | \
		xargs -r poetry run isort --check-only'

format-backend:
	$(DOCKER_COMPOSE) run --rm boneca poetry run black src tests
	$(DOCKER_COMPOSE) run --rm boneca poetry run isort src tests

format-branch-backend:
	$(DOCKER_COMPOSE) run --rm boneca /bin/bash -c '\
		git diff --name-only origin/main | grep "\.py$$" | \
		xargs -r poetry run black && \
		git diff --name-only origin/main | grep "\.py$$" | \
		xargs -r poetry run isort'

# Cleanup commands
clean-backend:
	$(DOCKER_COMPOSE) down -v --remove-orphans
	$(DOCKER_COMPOSE) rm -f
	docker system prune -f
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name "*.egg" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +

backend-lint:
	poetry run flake8 src tests
	poetry run mypy src tests
	poetry run black src tests --check
	poetry run isort src tests --check-only

backend-format:
	poetry run black src tests
	poetry run isort src tests

backend-lint-branch:
	git diff --name-only origin/main | grep '\.py$$' | xargs -r poetry run flake8
	git diff --name-only origin/main | grep '\.py$$' | xargs -r poetry run black --check
	git diff --name-only origin/main | grep '\.py$$' | xargs -r poetry run isort --check-only

backend-format-branch:
	git diff --name-only origin/main | grep '\.py$$' | xargs -r poetry run black
	git diff --name-only origin/main | grep '\.py$$' | xargs -r poetry run isort

backend-clean-local:
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name "*.egg" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name "*.egg" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
